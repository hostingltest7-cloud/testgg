name: Android 9 Emulator WebRTC

on: workflow_dispatch

jobs:
  android9:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y wget unzip curl \
            python3 python3-venv \
            docker-compose \
            libvirt-clients libvirt-daemon-system \
            bridge-utils qemu-kvm \
            lib32z1 lib32ncurses6 libbz2-1.0:i386 \
            xvfb pulseaudio socat

      - name: Setup emu-docker command
        run: |
          git clone https://github.com/google/android-emulator-container-scripts.git
          cd android-emulator-container-scripts
          source ./configure.sh

      - name: Build Android 9 Image
        run: |
          cd android-emulator-container-scripts
          emu-docker create --api 28 --tag google_apis --arch x86_64

      - name: Create WebRTC Container
        run: |
          cd android-emulator-container-scripts
          ./create_web_container.sh -s

      - name: Start Emulator (WebRTC)
        run: |
          cd android-emulator-container-scripts
          ./run.sh --emulator web &

      - name: Install Cloudflare Tunnel
        run: |
          curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

      - name: Expose Emulator via Cloudflare Tunnel
        run: |
          ./cloudflared tunnel --url http://localhost:6080 --no-autoupdate > cf.log 2>&1 &
          sleep 15
          echo "========== Emulator WebRTC Public URL =========="
          grep -oE "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" cf.log

      - name: Keep Session Alive
        run: |
          echo "Emulator running... keeping alive for 6h"
          sleep 21600
